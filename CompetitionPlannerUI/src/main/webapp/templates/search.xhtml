<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:p="http://primefaces.org/ui">
<head />
<body>
<ui:composition template="/templates/title.xhtml">
<ui:define name="content">

	<ui:param name="renderCrudButtonsValue" value="#{renderCrudButtons != null ? renderCrudButtons : true}"/>
	<ui:param name="renderNewButtonValue" value="#{renderNewButton != null ? renderNewButton : true}"/>
	<ui:param name="renderCopyButtonValue" value="#{renderCopyButton != null ? renderCopyButton : true}"/>

	<h:form id="datenForm" onkeypress="if (event.keyCode == 13) return false;">

		<h:outputScript>
		function checkEmpty() {
			if ($(".ui-datatable-empty-message").length > 0)
				updateResultCount(0);
		}
		function updateResultCount(count) {
			if (count == undefined)
				count = PF("suchErgebnisTable").tbody.children().length;
			var l = $("[id*=resultCountLabel]");
			l.text('#{bundle.format("count", "xxx")}'.replace(/xxx/, count));
		}
		function updateColumnWidth(buttonCount) {
			$("[id*=aktionenColumn]").css("width", "calc(2.5em * " + buttonCount + " + 10px)");
		}
		$(".ui-columntoggler").remove();
		
		</h:outputScript>

		<h:panelGrid columns="2" width="100%">
			<h:panelGroup layout="block" style="margin: 5px; float: left">
				<p:commandButton value="#{bundle.newButton}"
					action="#{searchBean.anlegen(bearbeitenLink, typ, editBean)}"
					process="@this"
					update=":mainContent"
					style="margin-right: 5px"
					rendered="#{renderCrudButtonsValue and renderNewButtonValue}"/>
	
				<ui:insert name="buttonExt"/>
			</h:panelGroup>
			<h:panelGroup layout="block" style="margin: 5px; float: right" rendered="#{renderDownloadPanel}">
				<p:commandButton value="#{bundle.download}"
						ajax="false"
						action="#{uploadBean.download(typ)}"
						style="float: left; margin-top: 3px">
				</p:commandButton>
				<h:panelGroup layout="block" style="float: left">
					<p:fileUpload fileUploadListener="#{uploadBean.upload}"
							update="importPanel suchErgebnisTable"
							multiple="true"
							label="#{bundle.chooseUpload}"
							uploadLabel="#{bundle.upload}"
							cancelLabel="#{messages.cancel}"
							style="float: left"/>
					<h:panelGrid id="importPanel" columns="3" style="margin: 5px" rendered="#{renderImportPanel}">
						<p:outputLabel value="#{bundle.format('uploaded', uploadBean.uploadedSize)}"/>
						<p:commandButton value="#{bundle.process}" action="#{uploadBean.processUploaded}"
								process="@this"
								update="importPanel :leftMenu suchErgebnisTable"
								disabled="#{uploadBean.uploadedSize == 0}"/>
						<p:commandButton value="#{messages.delete}" action="#{uploadBean.deleteUploaded}"
								process="@this"
								update="importPanel"
								disabled="#{uploadBean.uploadedSize == 0}"/>
					</h:panelGrid>
				</h:panelGroup>
			</h:panelGroup>
		</h:panelGrid>

		<p:dataTable id="suchErgebnisTable" widgetVar="suchErgebnisTable"
				var="item" rowKey="#{item.id}" rowIndexVar="rowIndex"
				value="#{searchBean.getDataModel(typ)}"
				lazy="true" paginator="true" paginatorAlwaysVisible="false"
				emptyMessage="#{bundle.noResult}" filterEvent="enter"
				sortMode="multiple" selectionMode="single" selection="#{searchBean.selectedItem}"
				binding="#{searchBean.datatable[null]}"
				rows="#{searchBean.numberOfRows}" rowsPerPageTemplate="50,100,500,1000"
				reflow="true">

			<f:facet name="header">
				<h:panelGroup id="resultCount">
					<p:outputLabel id="resultCountLabel"/>
				</h:panelGroup>
			</f:facet>

			<p:ajax event="page" listener="#{searchBean.onPagination}"/>
			<p:ajax event="filter" listener="#{searchBean.onFilter}" oncomplete="checkEmpty()"/>
			<p:ajax event="sort" listener="#{searchBean.onSort}"/>
			<p:ajax event="rowDblselect" listener="#{searchBean.bearbeiten(bearbeitenLink, typ, editBean)}" process="@form" update="mainContent"/>
			<f:event type="preRenderComponent" listener="#{searchBean.onPrerenderTable}"/>

			<p:columns var="column" value="#{searchBean.getColumns(typ)}"
					filterBy="#{item[column.property]}"
					filterValue="#{component.filters[''.concat(column.property)]}"
					sortBy="#{item[column.property]}"
					visible="#{column.visible}">
				<f:facet name="header">
					<h:outputText value="#{column.header}"/>
				</f:facet>
				<ui:param name="wert" value="#{searchBean.render(item, column)}"/>
				<ui:param name="isImage" value="#{wert.startsWith('data:image')}"/>
				<h:graphicImage value="#{wert}" rendered="#{isImage}"/>
				<h:outputText value="#{wert}" rendered="#{!isImage}"/>
			</p:columns>
			<!--  diese column is ggf. nicht sichtbar.. dann ist der Property-Value null -->
			<ui:param name="firstProperty" value="#{searchBean.getColumns(typ)[0].property}"/>

			<p:column id="aktionenColumn" toggleable="false" style="width: calc(2.5em * #{searchBean.getButtonCount(component)} + 10px)" styleClass="hiddenHintCol">
				<f:facet name="header">
					<h:outputText value="#{messages.tableHeaderActions}"/>
					<p:commandButton id="toggler" type="button" title="Spalten" style="float:right" icon="ui-icon-calculator" />
					<p:columnToggler datasource="suchErgebnisTable" trigger="toggler" widgetVar="toggler">
						<p:ajax event="toggle" listener="#{searchBean.columnChooserListener}" update="suchErgebnisTable" onstart="PF('toggler').hide()"/>
					</p:columnToggler>
				</f:facet>

				<p:commandButton id="bearbeitenButton" icon="ui-icon-pencil" title="#{bundle.modify}"
						action="#{searchBean.bearbeiten(bearbeitenLink, typ, item, editBean)}"
						process="@form"
						update=":mainContent"
						styleClass="editButton"
						rendered="#{renderCrudButtonsValue}"/>

				<ui:insert name="addRowButtons"/>

				<p:commandButton icon="ui-icon-copy" title="#{bundle.copy}"
						action="#{searchBean.kopieren(bearbeitenLink, typ, item, editBean)}"
						process="@this"
						update=":mainContent"
						rendered="#{renderCrudButtonsValue and renderCopyButtonValue}"/>
				<p:commandButton icon="ui-icon-trash" title="#{bundle.delete}"
						action="#{searchBean.loeschen(typ, item.id)}"
						process="@this"
						update="suchErgebnisTable messagesPopup"
						rendered="#{renderCrudButtonsValue}"
						onmousedown="updateConfirmDlg('#{messages.deleteTitle}', '#{bundle.format('comfirmMsg', item[firstProperty])}')"
						style="float: right;">
					<p:confirm icon=""/>
				</p:commandButton>
				<h:panelGroup layout="block" id="rowInfo" styleClass="hiddenHint"/>
				<h:outputScript rendered="#{rowIndex == 0}">
					updateResultCount(#{searchBean.getDataModel(typ).rowCount});
				</h:outputScript>
				<h:outputScript rendered="#{rowIndex == (searchBean.getDataModel(typ).rowCount - 1)}">
					updateColumnWidth(#{searchBean.getMaxButtonCount(component)});
				</h:outputScript>
			</p:column>
		</p:dataTable>

	</h:form>

</ui:define>
</ui:composition>
</body>
</html>