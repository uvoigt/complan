<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" 
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:p="http://primefaces.org/ui">

	<ui:composition template="/templates/title.xhtml">
		<ui:param name="bundle" value="#{messages.bundle('registrations')}"/>
		<ui:param name="bean" value="#{registrationBean}"/>
		<ui:param name="searchLink" value="/announcement/registrations.xhtml"/>

		<ui:param name="registration" value="#{registrationBean.registration}"/>

		<ui:define name="content">

			<style>
				.tableTop td {
					vertical-align: top
				}
				.tableTop td button:parent td {
					vertical-align: middle
				}
			</style>

			<h:form>

				<h:outputScript>
				function checkEmpty() {
					if ($("[id$=athletesTable] .ui-datatable-empty-message").length > 0)
						updateResultCount(0);
				}
				function updateResultCount(count) {
					if (count == undefined)
						count = PF("athletesTable").tbody.children().length;
					var l = $("[id*=resultCountLabel]");
					l.text('#{bundle.format("athletesCount", "xxx")}'.replace(/xxx/, count));
				}
				</h:outputScript>

				<table class="tableTop">
					<tr>
						<td style="width: 49%">
							<p:dataTable id="racesTable" widgetVar="racesTable"
									var="race" rowKey="#{race.id}"
									value="#{registrationBean.races}"
									emptyMessage="#{bundle.noRaces}"
									sortMode="multiple"
									selectionMode="multiple"
									selection="#{registrationBean.selectedRaces}"
									filterEvent="enter"
									rows="10"
									paginator="true" paginatorPosition="top"
									scrollable="false" scrollHeight="20%"
									style="width: 100%">

								<f:facet name="header">
									<p:outputLabel value="#{bundle.format('racesCount', registrationBean.races.size())}"/>
								</f:facet>

								<p:ajax event="rowSelect" oncomplete="registrationEdit_enableButtons()"/>
								<p:ajax event="rowUnselect" oncomplete="registrationEdit_enableButtons()"/>
								<p:ajax event="filter" oncomplete="PF('racesTable').unselectAllRows();registrationEdit_enableButtons()"/>

								<p:column headerText="#{bundle.number}" sortBy="#{race.number}" filterBy="#{race.number}" filterMatchMode="exact">
									<h:outputText value="#{race.number}"/>
								</p:column>
								<p:column headerText="#{bundle.boatClass}" sortBy="#{race.boatClass.text}" filterBy="#{race.boatClass.text}" filterMatchMode="contains">
									<h:outputText value="#{race.boatClass.text}"/>
								</p:column>
								<p:column id="ageType" headerText="#{bundle.ageType}" sortBy="#{race.ageType}" filterBy="#{race.ageType.text}" filterMatchMode="contains">
									<h:outputText value="#{race.ageType.text}"/>
								</p:column>
								<p:column id="gender" headerText="#{bundle.gender}" sortBy="#{race.gender.text}" filterBy="#{race.gender.text}" filterMatchMode="contains">
									<h:outputText value="#{race.gender.text}"/>
								</p:column>
								<p:column headerText="#{bundle.distance}" sortBy="#{race.distance}" filterBy="#{race.distance}" filterMatchMode="contains">
									<h:outputText value="#{race.distance}"/>
								</p:column>
							</p:dataTable>
						</td>
						<td style="vertical-align: middle;">
							<p:button icon="ui-icon-circle-arrow-e" title="#{bundle.copyFilter}"
								onclick="copyFilters(); return false;"
								style="margin-bottom: 1em"/>
							<p:commandButton icon="ui-icon-person" title="#{bundle.addRequest}"
								widgetVar="btnAddRequest"
								action="#{registrationBean.addRequest(bundle)}"
								process="@form"
								update="registrationTable"
								oncomplete="PF('registrationTable').filter()"
								style="margin-bottom: 1em"/>
							<p:commandButton icon="ui-icon-circle-arrow-s" title="#{bundle.addToRegistration}"
								widgetVar="btnAddAthlete"
								action="#{registrationBean.addToRegistration()}"
								process="@form"
								update="registrationTable"
								oncomplete="PF('registrationTable').filter()"/>
							<p:commandButton icon="ui-icon-arrowthick-1-w" title="#{messages.backToOverview}"
								action="#{startseiteBean.setMainContent('/announcement/registrations.xhtml')}"
								process="@this"
								update="mainContent"
								style="margin-top: 10em"/>
						</td>
						<td style="width: 49%">
							<h:inputHidden id="clubVisible" value="#{registrationBean.clubVisible}"/>
							<p:dataTable id="athletesTable" widgetVar="athletesTable"
									var="user" rowKey="#{user.id}"
									value="#{registrationBean.athletes}"
									emptyMessage="#{bundle.noAthletes}"
									sortMode="multiple"
									selectionMode="multiple"
									selection="#{registrationBean.selectedAthletes}"
									filterEvent="enter"
									rows="10" lazy="true" rowIndexVar="rowIndex"
									paginator="true" paginatorPosition="top"
									scrollable="false" scrollHeight="20%">

								<f:facet name="header">
									<h:panelGroup id="resultCount">
										<p:outputLabel id="resultCountLabel"/>
									</h:panelGroup>
									<p:commandButton id="toggler" action="#{registrationBean.toggleClubVisible()}"
										style="float:right; margin: -5px -10px 0 0;"
										icon="ui-icon-calculator" title="#{bundle.chooseClub}" onclick="toggleColumn(PF('athletesTable'), 1)"
										update="@form:clubVisible athletesTable"/>
								</f:facet>

								<p:ajax event="page" process="@form:clubVisible" update="@form:clubVisible"/>
								<p:ajax event="sort" process="@form:clubVisible" update="@form:clubVisible"/>
								<p:ajax event="rowSelect" oncomplete="registrationEdit_enableButtons()"/>
								<p:ajax event="rowUnselect" oncomplete="registrationEdit_enableButtons()"/>
								<p:ajax event="filter" process="@form:clubVisible" update="@form:clubVisible" oncomplete="PF('athletesTable').unselectAllRows();registrationEdit_enableButtons();checkEmpty()"/>
								<p:ajax event="rowDblselect" listener="#{registrationBean.addToRegistration()}" process="@form" update="@form:registrationTable"
									oncomplete="PF('registrationTable').filter()"/>

								<p:column headerText="#{bundle.club}" sortBy="#{user.club.name}" filterBy="#{user.club.name}" filterMatchMode="contains"
										visible="#{registrationBean.clubVisible}" filterValue="#{registrationBean.loggedInUser.club.name}">
									<h:outputText value="#{registrationBean.renderClubName(user)}"/>
								</p:column>
								<p:column headerText="#{bundle.firstName}" sortBy="#{user.firstName}" filterBy="#{user.firstName}" filterMatchMode="contains">
									<h:outputText value="#{user.firstName}"/>
								</p:column>
								<p:column headerText="#{bundle.lastName}" sortBy="#{user.lastName}" filterBy="#{user.lastName}" filterMatchMode="contains">
									<h:outputText value="#{user.lastName}"/>
								</p:column>
								<p:column id="ageType" headerText="#{bundle.ageType}" sortBy="#{user.birthDate}" filterBy="#{user.ageType}" filterMatchMode="contains">
									<h:outputText value="#{registrationBean.renderAgeType(user)}"/>
								</p:column>
								<p:column id="gender" headerText="#{bundle.gender}" sortBy="#{user.gender}" filterBy="#{user.gender}" filterMatchMode="contains">
									<h:outputText value="#{user.gender.text}"/>
								<h:outputScript rendered="#{rowIndex == 0}">
									updateResultCount(#{registrationBean.athletes.rowCount});
								</h:outputScript>
								</p:column>
							</p:dataTable>
						</td>
					</tr>
				</table>

				<p:dataTable id="registrationTable" widgetVar="registrationTable"
						var="entry" rowKey="#{entry.id}"
						value="#{registrationBean.registration.entries}"
						emptyMessage="#{bundle.noRegistrations}"
						sortMode="single"
						selectionMode="single"
						selection="#{registrationBean.selectedEntry}"
						rows="1000"
						filterEvent="enter"
						rowStyleClass="#{entry.race.boatClass.minimalTeamSize gt entry.participants.size() ? 'registrationIncomplete' : ''}">

					<f:facet name="header">
						<h:panelGroup layout="block" id="hallo">
							<h:outputText value="#{bundle.format('registrationsCount', registrationBean.registration.entries.size())}"/>
							<p:effect event="load" type="bounce" rendered="#{registrationBean.showEffect}"/>
						</h:panelGroup>
					</f:facet>

					<p:ajax event="rowSelect" oncomplete="registrationEdit_enableButtons()"/>
					<p:ajax event="rowUnselect" oncomplete="registrationEdit_enableButtons()"/>
					<p:ajax event="filter" oncomplete="PF('registrationTable').unselectAllRows()"/>

					<p:column headerText="#{bundle.race}" sortBy="#{entry.race.number}" filterBy="#{registrationBean.getRaceString(entry, bundle)}" filterMatchMode="contains" filterStyle="width: 80%">
						<h:outputText value="#{registrationBean.getRaceString(entry, bundle)}"/>
					</p:column>
					<p:column>
						<ui:repeat var="participant" value="#{entry.participants}" varStatus="status">
							<h:outputText value="#{'&lt;br /&gt;'}" escape="false" rendered="#{status.index > 0}"/>
							<h:outputText value="#{participant.remark != null ? participant.remark : participant.user.firstName} "/>
							<h:outputText value="#{participant.user.lastName}"/>
							<h:outputText value=" (#{participant.user.club.shortNameOrName})" rendered="#{participant.user.club.id != entry.registration.club.id and participant.remark == null}"/>
						</ui:repeat>
					</p:column>
					<p:column width="30">
						<p:commandButton icon="ui-icon-trash" title="#{bundle.deleteParticipant}"
								action="#{registrationBean.deleteFromRegistration(entry)}"
								process="@form:registrationTable"
								update="@form:registrationTable"
								oncomplete="PF('registrationTable').filter()"/>
					</p:column>
				</p:dataTable>

			</h:form>

			<h:outputScript>
				setTimeout(function() {
					registrationEdit_enableButtons();
				}, 50);
			</h:outputScript>

		</ui:define>
	</ui:composition>
</html>